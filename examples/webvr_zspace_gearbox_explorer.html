<!DOCTYPE html>
<html lang="en">
<head>
    <title>xeoEngine Example</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

    <script src="../build/xeoengine.js"></script>
    <link href="css/styles.css" rel="stylesheet"/>

    <script src="./js/libs/jquery-1.8.3.min.js"></script>

    <link rel="stylesheet" href="./js/libs/jstree/themes/default/style.min.css"/>
    <script src="./js/libs/jstree/jstree.min.js"></script>

    <script src="js/webvr/zSpace.js"></script>

<body>

<div id="infoLight" style="margin: 0; left:5px;">
    <a href="http://xeoengine.org" target="_home">xeoEngine</a>
    <br>
    using a <a
        href="../docs/classes/ZSpace.html"
        target="_docs">ZSpace</a> component to view a glTF <a href="../docs/classes/Model.html"
                                                              target="_docs">Model</a> with zSpace VR<br>

    click a node in the explorer below to fly to its <a href="../docs/classes/Entity.html"
                                                        target="_docs">Entity</a><br><br>

    <div><span id="log" style="color:red;font-size: 16px"></span></div>
</div>


<div id="explorerPanel"
     style="margin: 0; top: 160px; left:25px; opacity: 0.7;background: white; z-index:10000000; width: 300px; height:60%; position:absolute; overflow-y: scroll; overflow-x: hidden;">
    <div id="explorer" style=""></div>
</div>


<script>

    //---------------------------------------------------------------------------------------
    // In this demo, we:
    // 1. load a gearbox model from glTF format,
    // 2. build an explorer UI which can be used to navigate the entities in the gearbox, and
    // 3. enable display of the scene on a ZSpace device.
    //---------------------------------------------------------------------------------------

    $(document).ready(function () {

        //---------------------------------------------------------------------------------------
        // Load glTF gearbox model into the default scene
        //---------------------------------------------------------------------------------------

        var gearbox = new XEO.Model({
            src: "models/gltf/gearbox/gearbox_assy.gltf"
        });

        var scene = gearbox.scene;

        //---------------------------------------------------------------------------------------
        // Set initial position of the scene's default camera
        //---------------------------------------------------------------------------------------

        var view = scene.camera.view;

        view.eye = [184.21, 10.54, -7.03];
        view.look = [159.20, 17.02, 3.21];
        view.up = [-0.15, 0.97, 0.13];

        //---------------------------------------------------------------------------------------
        // Create a wireframe boundary entity to indicate the World-space
        // axis-aligned boundary of each entity we select in the explorer or drag with the stylus
        //---------------------------------------------------------------------------------------

        var boundingBox = new XEO.Entity({
            id: "myOBB",
            geometry: new XEO.BoundaryGeometry(),
            material: new XEO.PhongMaterial({
                diffuse: [0, 0, 0],
                ambient: [0, 0, 0],
                specular: [0, 0, 0],
                emissive: [1.0, 1.0, 0.5],
                lineWidth: 3
            }),
            visibility: new XEO.Visibility({
                visible: false
            }),
            modes: new XEO.Modes({
                collidable: false
            })
        });

        //----------------------------------------------------------------------------
        // Allow camera control with keyboard and mouse
        //----------------------------------------------------------------------------

        new XEO.CameraControl();

        //---------------------------------------------------------------------------------------
        // Create a camera flight animation, which flies the default camera to each Entity
        // as we select it in the explorer
        //---------------------------------------------------------------------------------------

        var cameraFlight = new XEO.CameraFlight();

        gearbox.on("loaded", function () {

            //---------------------------------------------------------------------------------------
            // When the Model has loaded, iterate over all the Entities in the Model:
            //
            // 1. Ensure that they each have their own Material and Modes components, so that
            // we can set them transparent individually. This is quick-and-dirty, where we
            // may be creating excess Materials and Modes, while needlessly keeping unused ones.
            //
            // 2. Add the Material and Modes to the Model's Collection so that they get
            // destroyed whenever the Model is destroyed or reloaded.
            //
            // 2. Add an item to the JSON data we'll build our explorer from.
            //---------------------------------------------------------------------------------------

            var data = [];
            var entities = gearbox.collection.types["XEO.Entity"];
            var entity;

            for (var entityId in entities) {
                if (entities.hasOwnProperty(entityId)) {

                    entity = entities[entityId];

                    // Ensure the Entity has its own unique Material and Modes

                    entity.material = entity.material.clone();
                    entity.material.opacity = 0.4;

                    entity.modes = entity.modes.clone();
                    entity.modes.transparent = true;

                    // Add the Material and Modes to the Model's Collection
                    // so that they get destroyed automatically

                    gearbox.collection.add(entity.material);
                    gearbox.collection.add(entity.modes);

                    // Flatten modelling transform hierarchies

                    if (entity.transform && entity.transform.parent) {

                        // If an entity has a transform that has a parent, then the entity's
                        // transform hierarchy needs collapsing. Bake the hierarchy into
                        // a matrix on a single XEO.Transform and set that as the entity's new transform.

                        entity.transform =  new XEO.Transform({
                            matrix: entity.transform.leafMatrix
                        });

                        // Store the new transform in the Model's Collection so that
                        // it gets destroyed when the Model is destroyed or reloaded

                        gearbox.collection.add(entity.transform);
                    }

                    // To each Entity it loads, a Model will attach metadata
                    // containing a human-readable name - use that to list a
                    // human-readable name in the explorer.

                    data.push({
                        id: entity.id,
                        text: entity.meta.name || "unnamed"
                    })
                }
            }

            //---------------------------------------------------------------------------------------
            // Build explorer (using JSTree), bind a selection handler
            // that flies to the selected Entity
            //---------------------------------------------------------------------------------------

            var nextEntity; // Next entity we'll fly to
            var lastEntity; // Last entity we flew to

            // Build explorer tree
            $('#explorer').jstree({
                'core': {
                    'data': data
                }
            })
                // Bind selection handler
                    .on("changed.jstree",
                    function (e, data) {
                        if (data.selected.length) {

                            var entityId = data.instance.get_node(data.selected[0]).id;

                            nextEntity = scene.components[entityId];

                            if (lastEntity) {
                                lastEntity.modes.transparent = true;
                            }

                            nextEntity.modes.transparent = false;

                            boundingBox.geometry.obb = nextEntity.worldBoundary.obb;
                            boundingBox.visibility.visible = true;

                            cameraFlight.flyTo({
                                        aabb: nextEntity.worldBoundary.aabb, // Fly to entity's AABB
                                        stopFOV: 75, // Make sure the camera stops far enough back from the entity
                                        duration: 1.0 // One second flight time to each entity
                                    },
                                    function () {
                                        // Camera has arrived at entity
                                    });

                            lastEntity = nextEntity;
                        }
                    });
        });

        //---------------------------------------------------------------------------------------
        // Create a ZSpace effect
        //---------------------------------------------------------------------------------------

        var zspace = new XEO.ZSpace();

        //----------------------------------------------------------------------------
        // Check if we're actually running on a ZSpace device
        //----------------------------------------------------------------------------

        zspace.on("supported", function (supported) {

            if (!supported) {

                //----------------------------------------------------------------------------
                // ZSpace not detected, show a messsage
                //----------------------------------------------------------------------------

                document.getElementById("log").innerText = "This computer is not a zSpace viewer - defaulting to standard xeoEngine camera controls. ";

            } else { // ZSpace detected

                //----------------------------------------------------------------------------
                // Create helper to show stylus position
                //----------------------------------------------------------------------------

                var stylusHelper = new (function () {

                    var entity = new XEO.Entity({
                        geometry: new XEO.Geometry({
                            primitive: "lines",
                            positions: [0, 0, 0, 0, 0, 0],
                            indices: [0, 1]
                        }),
                        material: new XEO.PhongMaterial({
                            emissive: [1, 0.3, 0.3],
                            diffuse: [0, 0, 0],
                            ambient: [0, 0, 0],
                            lineWidth: 3
                        }),
                        modes: new XEO.Modes({pickable: false})
                    });

                    var positions = new Float32Array(6);

                    this.setPosition = function (pos, dir) {
                        positions[0] = pos[0]; // Origin
                        positions[1] = pos[1];
                        positions[2] = pos[2];
                        positions[3] = pos[0] + dir[0]; // Direction
                        positions[4] = pos[1] + dir[1];
                        positions[5] = pos[2] + dir[2];
                        entity.geometry.positions = positions;
                    };

                    this.setHighlighted = function (highlighted) {
                        entity.material.emissive = highlighted ? [0.3, 1.0, 0.3] : [1.0, 0.3, 0.3];
                        entity.material.lineWidth = highlighted ? 5 : 3;
                    };
                })();

                //----------------------------------------------------------------------------
                //
                //----------------------------------------------------------------------------

                var draggingEntity = false;
                var draggingStartPos = XEO.math.vec3();
                var stylusIsectLen;

                zspace.on("stylusButton0", (function () {

                    var stylusDir = XEO.math.vec3();
                    var stylusIsectDir = XEO.math.vec3();

                    return function (down) {

                        if (!down) {
                            if (draggingEntity) {
                                draggingEntity.material.emissive = [0.0, 0.0, 0.0];
                                boundingBox.visibility.visible = false;
                                draggingEntity = null;
                            }
                            return;
                        }

                        var stylusPos = zspace.stylusPos;
                        XEO.math.mulVec3Scalar(zspace.stylusDir, 100, stylusDir);

                        var hit = scene.pick({
                            pickSurface: true, // <<----- Picking point on surface
                            origin: stylusPos,
                            direction: stylusDir
                        });

                        if (hit) { // Stylus hits an Entity

                            var entity = hit.entity;

                            if (!entity.transform || !entity.transform.meta.stylusTransform) {
                                entity.transform = new XEO.Translate({
                                    meta: {
                                        stylusTransform: true
                                    },
                                    xyz: [0, 0, 0],
                                    parent: entity.transform,
                                    postMultiply: false
                                });
                            }
                            draggingEntity = entity;
                            draggingEntity.material.emissive = [0.3, 1.0, 0.3];
                            draggingStartPos.set(hit.worldPos);
                            XEO.math.subVec3(hit.worldPos, stylusPos, stylusIsectDir);
                            stylusIsectLen = XEO.math.lenVec3(stylusIsectDir);

                            boundingBox.geometry.obb = draggingEntity.worldBoundary.obb;
                            boundingBox.visibility.visible = true;

                            console.log("1: " + hit.worldPos);
                        }
                    };
                })());

                //----------------------------------------------------------------------------
                //
                //----------------------------------------------------------------------------

                zspace.on("stylusMoved", (function () {

                    var stylusDir = XEO.math.vec3();
                    var stylusIsectDir = XEO.math.vec3();
                    var stylusIsect = XEO.math.vec3();
                    var xyz = XEO.math.vec3();

                    return function () {

                        var stylusPos = zspace.stylusPos;

                        XEO.math.mulVec3Scalar(zspace.stylusDir, 100, stylusDir);

                        stylusHelper.setPosition(stylusPos, stylusDir);

                        if (draggingEntity) {

                            XEO.math.mulVec3Scalar(zspace.stylusDir, stylusIsectLen, stylusIsectDir);
                            XEO.math.addVec3(zspace.stylusPos, stylusIsectDir, stylusIsect);

                            XEO.math.subVec3(stylusIsect, draggingStartPos, xyz);

                            draggingEntity.transform.xyz = xyz;

                            console.log("2: " + stylusIsect);

                        } else {

                            var hit = scene.pick({
                                pickSurface: false, // Default
                                origin: stylusPos,
                                direction: stylusDir
                            });

                            if (hit) {
                                stylusHelper.setHighlighted(true);

                            } else {
                                stylusHelper.setHighlighted(false);
                            }
                        }
                    };
                })());

            }
        });
    });
</script>
</body>
</html>