<!DOCTYPE html>
<html lang="en">
<head>
    <title>xeoEngine Example</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

    <link href="css/styles.css" rel="stylesheet"/>

    <script src="../build/xeoengine.min.js"></script>

    <script src="js/webvr/zSpace.js"></script>

<body>

<div id="infoLight"
     style="left: 0; text-align: left; background: black; opacity: 0.7; padding: 8px; color: white; font-size: 14pt;">
    <span><a href="http://xeoengine.org" target="_home">xeoEngine</a><br>using a <a
            href="../docs/classes/ZSpace.html"
            target="_docs">ZSpace</a> component to view a glTF <a
            href="../docs/classes/Model.html"
            target="_docs">Model</a> with zSpace VR</span><br>
    <span id="log" style="color:red;font-size: 16px"></span>
</div>

<script>

    //---------------------------------------------------------------------------------------
    // In this demo, we:
    // 1. load a gearbox model from glTF format,
    // 2. enable display of the scene on a ZSpace device,
    // 3. if ZSpace device detected, then
    // 3.1 create a couple of helper entities to show the location of the ZSpace stylus in
    //      the 3D scene and the points at which it intersects entities as we move it around
    // 3.2 subscribe to stylus movement and buttons, so that we can use it to pick entities
    //---------------------------------------------------------------------------------------

    //----------------------------------------------------------------------------
    // Load a glTF gearbox model into the default Scene
    //----------------------------------------------------------------------------

    var gearbox = new XEO.Model({
        src: "models/gltf/gearbox/gearbox_assy.gltf"
    });

    gearbox.on("loaded", function () {

        //---------------------------------------------------------------------------------------
        // When the Model has loaded, iterate over all the Entities in the Model:
        //
        // 1. Ensure that they each have their own Material and Modes components, so that
        // we can set them transparent individually. This is quick-and-dirty, where we
        // may be creating excess Materials and Modes, while needlessly keeping unused ones.
        //
        // 2. Add the Material and Modes to the Model's Collection so that they get
        // destroyed whenever the Model is destroyed or reloaded.
        //
        // 2. Add an item to the JSON data we'll build our explorer from.
        //---------------------------------------------------------------------------------------

        var entities = gearbox.collection.types["XEO.Entity"];
        var entity;

        for (var entityId in entities) {
            if (entities.hasOwnProperty(entityId)) {

                entity = entities[entityId];

                // Ensure the Entity has its own unique Material
                // Add the Material and Modes to the Model's Collection
                // so that they get destroyed automatically

                gearbox.collection.add(entity.material = entity.material.clone());

                // Flatten modelling transform hierarchies

                if (entity.transform && entity.transform.parent) {

                    // If an entity has a transform that has a parent, then the entity's
                    // transform hierarchy needs collapsing. Bake the hierarchy into
                    // a matrix on a single XEO.Transform and set that as the entity's new transform.
                    // Store the new transform in the Model's Collection so that
                    // it gets destroyed when the Model is destroyed or reloaded

                    gearbox.collection.add(entity.transform = new XEO.Transform({
                        matrix: entity.transform.leafMatrix
                    }));
                }
            }
        }
    });

    //----------------------------------------------------------------------------
    // Set initial camera position
    //----------------------------------------------------------------------------

    var view = gearbox.scene.camera.view;

    view.eye = [184.21, 10.54, -7.03];
    view.look = [159.20, 17.02, 3.21];
    view.up = [-0.15, 0.97, 0.13];

    var scene = gearbox.scene;

    //----------------------------------------------------------------------------
    // Create a ZSpace effect
    //----------------------------------------------------------------------------

    var zspace = new XEO.ZSpace();

    //----------------------------------------------------------------------------
    // Allow camera control with keyboard and mouse
    //----------------------------------------------------------------------------

    new XEO.CameraControl();

    //---------------------------------------------------------------------------------------
    // Create a wireframe boundary entity to indicate the World-space
    // axis-aligned boundary of each entity we drag with the stylus
    //---------------------------------------------------------------------------------------

    var boundaryHelper = new (function () {

        var boundary = new XEO.Entity({
            id: "myOBB",
            geometry: new XEO.BoundaryGeometry(),
            material: new XEO.PhongMaterial({
                diffuse: [0, 0, 0],
                ambient: [0, 0, 0],
                specular: [0, 0, 0],
                emissive: [1.0, 1.0, 0.5],
                lineWidth: 3
            }),
            visibility: new XEO.Visibility({
                visible: false
            }),
            modes: new XEO.Modes({
                collidable: false
            })
        });

        this.update = function (entity) {
            boundary.visibility.visible = !!entity;
            if (entity) {
                boundary.geometry.obb = entity.worldBoundary.obb;
            }
        };
    })();


    //----------------------------------------------------------------------------
    // Check if we're actually running on a ZSpace device
    //----------------------------------------------------------------------------

    zspace.on("supported", function (supported) {

        if (!supported) {

            //----------------------------------------------------------------------------
            // ZSpace not detected, show a messsage
            //----------------------------------------------------------------------------

            document.getElementById("log").innerText = "This computer is not a zSpace viewer - defaulting to standard xeoEngine camera controls. ";

        } else { // ZSpace detected

            //----------------------------------------------------------------------------
            // Create helper to show stylus position
            //----------------------------------------------------------------------------

            var stylusHelper = new (function () {

                var entity = new XEO.Entity({
                    geometry: new XEO.Geometry({
                        primitive: "lines",
                        positions: [0, 0, 0, 0, 0, 0],
                        indices: [0, 1]
                    }),
                    material: new XEO.PhongMaterial({
                        emissive: [1, 0.3, 0.3],
                        diffuse: [0, 0, 0],
                        ambient: [0, 0, 0],
                        lineWidth: 3
                    }),
                    modes: new XEO.Modes({pickable: false})
                });

                var positions = new Float32Array(6);

                this.setPosition = function (pos, dir) {
                    positions[0] = pos[0]; // Origin
                    positions[1] = pos[1];
                    positions[2] = pos[2];
                    positions[3] = pos[0] + dir[0]; // Direction
                    positions[4] = pos[1] + dir[1];
                    positions[5] = pos[2] + dir[2];
                    entity.geometry.positions = positions;
                };

                this.setHighlighted = function (highlighted) {
                    entity.material.emissive = highlighted ? [0.3, 1.0, 0.3] : [1.0, 0.3, 0.3];
                    entity.material.lineWidth = highlighted ? 5 : 3;
                };
            })();

            //----------------------------------------------------------------------------
            //
            //----------------------------------------------------------------------------

            var draggingEntity = false;
            var draggingStartPos = XEO.math.vec3();
            var stylusIsectLen;

            zspace.on("stylusButton0", (function () {

                var stylusDir = XEO.math.vec3();
                var stylusIsectDir = XEO.math.vec3();

                return function (down) {

                    if (!down) {
                        if (draggingEntity) {
                            draggingEntity.material.emissive = [0.0, 0.0, 0.0];
                            draggingEntity = null;
                        }
                        return;
                    }

                    var stylusPos = zspace.stylusPos;
                    XEO.math.mulVec3Scalar(zspace.stylusDir, 100, stylusDir);

                    var hit = scene.pick({
                        pickSurface: true, // <<----- Picking point on surface
                        origin: stylusPos,
                        direction: stylusDir
                    });

                    if (hit) { // Stylus hits an Entity

                        var entity = hit.entity;

                        if (!entity.transform || !entity.transform.meta.stylusTransform) {
                            entity.transform = new XEO.Translate({
                                meta: {
                                    stylusTransform: true
                                },
                                xyz: [0, 0, 0],
                                parent: entity.transform,
                                postMultiply: false
                            });
                        }
                        draggingEntity = entity;
                        draggingEntity.material.emissive = [0.0, 1.0, 0.0];
                        draggingStartPos.set(hit.worldPos);
                        XEO.math.subVec3(hit.worldPos, stylusPos, stylusIsectDir);
                        stylusIsectLen = XEO.math.lenVec3(stylusIsectDir);

                        console.log("1: " + hit.worldPos);
                    }
                };
            })());

            //----------------------------------------------------------------------------
            //
            //----------------------------------------------------------------------------

            zspace.on("stylusMoved", (function () {

                var stylusDir = XEO.math.vec3();
                var stylusIsectDir = XEO.math.vec3();
                var stylusIsect = XEO.math.vec3();
                var xyz = XEO.math.vec3();
                var lastEntityHighlighted = null;

                return function () {

                    var stylusPos = zspace.stylusPos;

                    XEO.math.mulVec3Scalar(zspace.stylusDir, 100, stylusDir);

                    stylusHelper.setPosition(stylusPos, stylusDir);

                    if (draggingEntity) {

                        XEO.math.mulVec3Scalar(zspace.stylusDir, stylusIsectLen, stylusIsectDir);
                        XEO.math.addVec3(zspace.stylusPos, stylusIsectDir, stylusIsect);

                        XEO.math.subVec3(stylusIsect, draggingStartPos, xyz);

                        draggingEntity.transform.xyz = xyz;

                    } else {

                        var hit = scene.pick({
                            pickSurface: false, // Default
                            origin: stylusPos,
                            direction: stylusDir
                        });

                        if (lastEntityHighlighted) {
                            if (!hit || (hit.entity.id !== lastEntityHighlighted.id)) {
                                lastEntityHighlighted.material.emissive = [0, 0, 0];
                            }
                        }

                        if (hit) {
                            stylusHelper.setHighlighted(true);
                            hit.entity.material.emissive = [0, 0.5, 0];
                            lastEntityHighlighted = hit.entity;

                        } else {
                            stylusHelper.setHighlighted(false);
                            lastEntityHighlighted = null;
                        }
                    }
                };
            })());
        }
    });
</script>
</body>
</html>