<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/_renderer/webgl/megatexture/cache.js - xeoengine</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">

                <h1 style="color:white;"><a href="../../">xeoEngine</a> / <a href="../../docs">API Docs</a></h1>

        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.1.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/AmbientLight.html">AmbientLight</a></li>
                                <li><a href="../classes/Billboard.html">Billboard</a></li>
                                <li><a href="../classes/Boundary2D.html">Boundary2D</a></li>
                                <li><a href="../classes/Boundary3D.html">Boundary3D</a></li>
                                <li><a href="../classes/BoundaryGeometry.html">BoundaryGeometry</a></li>
                                <li><a href="../classes/BoxGeometry.html">BoxGeometry</a></li>
                                <li><a href="../classes/Camera.html">Camera</a></li>
                                <li><a href="../classes/CameraControl.html">CameraControl</a></li>
                                <li><a href="../classes/CameraController.html">CameraController</a></li>
                                <li><a href="../classes/CameraFlight.html">CameraFlight</a></li>
                                <li><a href="../classes/Canvas.html">Canvas</a></li>
                                <li><a href="../classes/Cardboard.html">Cardboard</a></li>
                                <li><a href="../classes/Clip.html">Clip</a></li>
                                <li><a href="../classes/Clips.html">Clips</a></li>
                                <li><a href="../classes/Collection.html">Collection</a></li>
                                <li><a href="../classes/CollectionBoundary.html">CollectionBoundary</a></li>
                                <li><a href="../classes/ColorBuf.html">ColorBuf</a></li>
                                <li><a href="../classes/ColorTarget.html">ColorTarget</a></li>
                                <li><a href="../classes/Component.html">Component</a></li>
                                <li><a href="../classes/Configs.html">Configs</a></li>
                                <li><a href="../classes/CubicBezierCurve.html">CubicBezierCurve</a></li>
                                <li><a href="../classes/Cull.html">Cull</a></li>
                                <li><a href="../classes/Curve.html">Curve</a></li>
                                <li><a href="../classes/CylinderGeometry.html">CylinderGeometry</a></li>
                                <li><a href="../classes/DepthBuf.html">DepthBuf</a></li>
                                <li><a href="../classes/DepthTarget.html">DepthTarget</a></li>
                                <li><a href="../classes/DirLight.html">DirLight</a></li>
                                <li><a href="../classes/Entity.html">Entity</a></li>
                                <li><a href="../classes/Fresnel.html">Fresnel</a></li>
                                <li><a href="../classes/Frustum.html">Frustum</a></li>
                                <li><a href="../classes/Geometry.html">Geometry</a></li>
                                <li><a href="../classes/HeightmapGeometry.html">HeightmapGeometry</a></li>
                                <li><a href="../classes/Input.html">Input</a></li>
                                <li><a href="../classes/KeyboardAxisCamera.html">KeyboardAxisCamera</a></li>
                                <li><a href="../classes/KeyboardPanCamera.html">KeyboardPanCamera</a></li>
                                <li><a href="../classes/KeyboardRotateCamera.html">KeyboardRotateCamera</a></li>
                                <li><a href="../classes/KeyboardZoomCamera.html">KeyboardZoomCamera</a></li>
                                <li><a href="../classes/LatheGeometry.html">LatheGeometry</a></li>
                                <li><a href="../classes/Layer.html">Layer</a></li>
                                <li><a href="../classes/Lights.html">Lights</a></li>
                                <li><a href="../classes/Lookat.html">Lookat</a></li>
                                <li><a href="../classes/Material.html">Material</a></li>
                                <li><a href="../classes/MegaTexture.html">MegaTexture</a></li>
                                <li><a href="../classes/Model.html">Model</a></li>
                                <li><a href="../classes/Modes.html">Modes</a></li>
                                <li><a href="../classes/MorphTargets.html">MorphTargets</a></li>
                                <li><a href="../classes/MousePanCamera.html">MousePanCamera</a></li>
                                <li><a href="../classes/MousePickEntity.html">MousePickEntity</a></li>
                                <li><a href="../classes/MouseRotateCamera.html">MouseRotateCamera</a></li>
                                <li><a href="../classes/MouseZoomCamera.html">MouseZoomCamera</a></li>
                                <li><a href="../classes/Nintendo3DSGeometry.html">Nintendo3DSGeometry</a></li>
                                <li><a href="../classes/OBJGeometry.html">OBJGeometry</a></li>
                                <li><a href="../classes/Ortho.html">Ortho</a></li>
                                <li><a href="../classes/Path.html">Path</a></li>
                                <li><a href="../classes/PathGeometry.html">PathGeometry</a></li>
                                <li><a href="../classes/Perspective.html">Perspective</a></li>
                                <li><a href="../classes/PhongMaterial.html">PhongMaterial</a></li>
                                <li><a href="../classes/PlaneGeometry.html">PlaneGeometry</a></li>
                                <li><a href="../classes/PointLight.html">PointLight</a></li>
                                <li><a href="../classes/QuadraticBezierCurve.html">QuadraticBezierCurve</a></li>
                                <li><a href="../classes/Quaternion.html">Quaternion</a></li>
                                <li><a href="../classes/Reflect.html">Reflect</a></li>
                                <li><a href="../classes/Render.html">Render</a></li>
                                <li><a href="../classes/Rotate.html">Rotate</a></li>
                                <li><a href="../classes/Scale.html">Scale</a></li>
                                <li><a href="../classes/Scene.html">Scene</a></li>
                                <li><a href="../classes/Shader.html">Shader</a></li>
                                <li><a href="../classes/ShaderParams.html">ShaderParams</a></li>
                                <li><a href="../classes/Skybox.html">Skybox</a></li>
                                <li><a href="../classes/SphereGeometry.html">SphereGeometry</a></li>
                                <li><a href="../classes/Spinner.html">Spinner</a></li>
                                <li><a href="../classes/SplineCurve.html">SplineCurve</a></li>
                                <li><a href="../classes/Stage.html">Stage</a></li>
                                <li><a href="../classes/Stationary.html">Stationary</a></li>
                                <li><a href="../classes/TeapotGeometry.html">TeapotGeometry</a></li>
                                <li><a href="../classes/Texture.html">Texture</a></li>
                                <li><a href="../classes/TorusGeometry.html">TorusGeometry</a></li>
                                <li><a href="../classes/Transform.html">Transform</a></li>
                                <li><a href="../classes/Translate.html">Translate</a></li>
                                <li><a href="../classes/VectorTextGeometry.html">VectorTextGeometry</a></li>
                                <li><a href="../classes/Viewport.html">Viewport</a></li>
                                <li><a href="../classes/Visibility.html">Visibility</a></li>
                                <li><a href="../classes/WebVR.html">WebVR</a></li>
                                <li><a href="../classes/XEO.html">XEO</a></li>
                                <li><a href="../classes/XEO.math.math.html">XEO.math.math</a></li>
                                <li><a href="../classes/ZSpace.html">ZSpace</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="..//modules/animation.html">animation</a></li>
                                <li><a href="..//modules/boundaries.html">boundaries</a></li>
                                <li><a href="..//modules/camera.html">camera</a></li>
                                <li><a href="..//modules/canvas.html">canvas</a></li>
                                <li><a href="..//modules/clipping.html">clipping</a></li>
                                <li><a href="..//modules/collections.html">collections</a></li>
                                <li><a href="..//modules/configs.html">configs</a></li>
                                <li><a href="..//modules/controls.html">controls</a></li>
                                <li><a href="..//modules/culling.html">culling</a></li>
                                <li><a href="..//modules/curves.html">curves</a></li>
                                <li><a href="..//modules/entities.html">entities</a></li>
                                <li><a href="..//modules/geometry.html">geometry</a></li>
                                <li><a href="..//modules/importing.html">importing</a></li>
                                <li><a href="..//modules/input.html">input</a></li>
                                <li><a href="..//modules/interaction.html">interaction</a></li>
                                <li><a href="..//modules/lighting.html">lighting</a></li>
                                <li><a href="..//modules/materials.html">materials</a></li>
                                <li><a href="..//modules/math.html">math</a></li>
                                <li><a href="..//modules/paths.html">paths</a></li>
                                <li><a href="..//modules/rendering.html">rendering</a></li>
                                <li><a href="..//modules/shaders.html">shaders</a></li>
                                <li><a href="..//modules/skyboxes.html">skyboxes</a></li>
                                <li><a href="..//modules/transforms.html">transforms</a></li>
                                <li><a href="..//modules/webvr.html">webvr</a></li>
                                <li><a href="..//modules/XEO.html">XEO</a></li>
                                <li><a href="..//modules/xeogl.html">xeogl</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <!--<div id="api-options">-->
                    <!--Show:-->
                    <!--<label for="api-show-inherited">-->
                        <!--<input type="checkbox" id="api-show-inherited" checked>-->
                        <!--Inherited-->
                    <!--</label>-->
            
                    <!--<label for="api-show-protected">-->
                        <!--<input type="checkbox" id="api-show-protected">-->
                        <!--Protected-->
                    <!--</label>-->
            
                    <!--<label for="api-show-private">-->
                        <!--<input type="checkbox" id="api-show-private">-->
                        <!--Private-->
                    <!--</label>-->
                    <!--<label for="api-show-deprecated">-->
                        <!--<input type="checkbox" id="api-show-deprecated">-->
                        <!--Deprecated-->
                    <!--</label>-->
            
                <!--</div>-->
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: src/_renderer/webgl/megatexture/cache.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
(function() {

    &quot;use strict&quot;;

    var Cache = xeogl.renderer.webgl.megaTexture.Cache = function (gl, tileSize, tileOverlap, tilesPerSide) {

        this.gl = gl;

        this.totalTileSize = tileSize + (tileOverlap * 2);
        this.tileSize = tileSize;
        this.tileOverlap = tileOverlap;
        this.tilesPerSide = tilesPerSide;
        this.tileCapacity = tilesPerSide * tilesPerSide;
        this.width = this.height = this.totalTileSize * tilesPerSide;

        this.texture = gl.createTexture();

        gl.bindTexture(gl.TEXTURE_2D, this.texture);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
        emptyTexImage2D(gl, gl.RGB, this.width, this.height, gl.RGB, gl.UNSIGNED_BYTE);
        gl.bindTexture(gl.TEXTURE_2D, null);

        this.framebuffer = gl.createFramebuffer();

        gl.bindFramebuffer(gl.FRAMEBUFFER, this.framebuffer);
        gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, this.texture, 0);
        gl.bindFramebuffer(gl.FRAMEBUFFER, null);

        this.freeTiles = [];

        for (var n = 0; n &lt; this.tileCapacity; n++) {
            this.freeTiles.push(n);
        }

        // map of texture/level/x/y to xeogl.renderer.webgl.megaTexture.MegaTextureRef

        this.tiles = {};
        this.tileList = [];

        this.megaTextures = {};

        this.quadDrawer = new HNGLQuadDrawer(gl);
    };

    function emptyTexImage2D(gl, internalFormat, width, height, format, type) {
        try {
            gl.texImage2D(gl.TEXTURE_2D, 0, internalFormat, width, height, 0, format, type, null);
        } catch (e) {
            console.warn(&quot;browser texImage2D does not accept null - sending up a real blank texture&quot;);
            var pixels = new WebGLUnsignedByteArray(width * height * ( internalFormat == gl.RGBA ? 4 : 3 ));
            gl.texImage2D(gl.TEXTURE_2D, 0, internalFormat, width, height, 0, format, type, pixels);
        }
    }

    Cache.prototype.registerMegaTexture = function (megaTexture) {

        this.megaTextures[megaTexture.id] = megaTexture;

        megaTexture.lookup = new xeogl.renderer.webgl.megaTexture.Lookup(this, megaTexture);
    };


    Cache.prototype.unregisterMegaTexture = function (megaTexture) {

        // NOTE: our tiles will be cleaned up by the LRU automatically,
        // although it&#x27;d be nice if we got rid of them to make debugging easier

        megaTexture.lookup.destroy();
        megaTexture.lookup = null;

        delete this.megaTextures[megaTexture.id];
    };

    /**
     * Processes completed tiles.
     * @method processCompletedTiles
     * @param renderFrameNumber
     * @param loader
     */
    Cache.prototype.processCompletedTiles = function (renderFrameNumber, loader) {

        // Limit to just a few tiles per frame for now
        var completedTiles = loader.getCompletedTiles(2, renderFrameNumber);

        if (completedTiles.length &gt; 0) {

            this.beginUpdate(renderFrameNumber);

            var tileCapacityDiff = this.tileList.length + completedTiles.length - this.tileCapacity;

            if (tileCapacityDiff &gt; 0) {
                this.removeUnusedTiles(tileCapacityDiff);
            }

            for (var n = 0; n &lt; completedTiles.length; n++) {
                this.addTile(completedTiles[n]);
            }

            this.endUpdate();
        }

        // Update the quad trees if required
        // TODO: only update every few frames if just adds - removes have to be done right away, though

        for (var id in this.megaTextures) {
            if (this.megaTextures.hasOwnProperty(id)) {
                this.megaTextures[id].lookup.processChanges();
            }
        }
    };

    Cache.prototype.beginUpdate = function (frameNumber) {

        var gl = this.gl;
        gl.bindFramebuffer(gl.FRAMEBUFFER, this.framebuffer);

        this.quadDrawer.beginBatch(this.width, this.height);

        this.lastFrameNumber = frameNumber;
    };

    Cache.prototype.removeUnusedTiles = function (requestedRemovalCount) {

        this.tileList.sort(function (a, b) {
            return a.lastUse - b.lastUse;
        });

        for (var removalCount = 0; (removalCount &lt; requestedRemovalCount) &amp;&amp; (this.tileList.length &gt; 0); removalCount++) {

            var tileRef = this.tileList[0];

            if (tileRef.lastUse + 4 &gt;= this.lastFrameNumber) {
                // Recently used - don&#x27;t evict
                // NOTE: since we are sorted, we know we have hit the limit - abort
                // console.warn(&quot;texture cache thrashing&quot;);
                break;
            }

            this.removeTile(tileRef);
        }
    };

    Cache.prototype.endUpdate = function () {

        var gl = this.gl;

        this.quadDrawer.endBatch();

        gl.bindFramebuffer(gl.FRAMEBUFFER, null);
    };

    Cache.prototype.addTile = function (tile) {

        var gl = this.gl;

        // texture must actually be registered
        if (!tile.megaTexture.lookup) {
            console.debug(&quot;attempt to add tile from unregistered megatexture - aborting&quot;);
            return false;
        }

        var key = [
            tile.megaTexture.id,
            tile.level,
            tile.tileX,
            tile.tileY
        ].join(&quot;,&quot;);

        // console.assert(!this.tiles[key], &quot;re-adding existing tile&quot;);

        if (this.freeTiles.length == 0) {
            console.warn(&quot;tile cache full - unable to add tile&quot;);
            return false;
        }

        // TODO: maybe not do this here?

        var texture = tile.uploadTexture(gl);

        if (!texture) {
            return false;
        }

        var n = this.freeTiles.pop();
        var sx = Math.floor(n % this.tilesPerSide) * this.totalTileSize;
        var sy = Math.floor(n / this.tilesPerSide) * this.totalTileSize;
        var sw = texture.width;
        var sh = texture.height;

        if (this.tileOverlap) {
            if (tile.tileX == 0) {
                sx += this.tileOverlap;
            }
            if (tile.tileY == 0) {
                sy += this.tileOverlap;
            }
        }

        // TODO: rescale if smaller or larger than native tile size
        this.quadDrawer.draw(texture.id, sx, sy, sw, sh, false);

        texture.destroy();

        var tileRef = new xeogl.renderer.webgl.megaTexture.MegaTextureRef(tile);

        tileRef.bindToSlot(n, texture.width, texture.height);
        tileRef.touch(this.lastFrameNumber);

        this.tiles[key] = tileRef;
        this.tileList.push(tileRef);

        // Find our direct parent and add to the tree
        if (tile.level &gt; 0) {
            var px = Math.floor(tile.tileX / 2);
            var py = Math.floor(tile.tileY / 2);
            // If it doesn&#x27;t exist, it&#x27;s ok - we&#x27;ll get fixed up when it gets added
            tileRef.parent = this.getTileRef(tile.megaTexture.id, tile.level - 1, px, py);
            if (tileRef.parent) {
                tileRef.parent.children[(tile.tileY % 2) * 2 + (tile.tileX % 2)] = tileRef;
            }
        }
        // Search for our 4 children
        if (tile.level &lt; tile.megaTexture.maxLevel) {
            tileRef.children[0] = this.getTileRef(tile.megaTexture.id, tile.level + 1, tile.tileX * 2 + 0, tile.tileY * 2 + 0);
            tileRef.children[1] = this.getTileRef(tile.megaTexture.id, tile.level + 1, tile.tileX * 2 + 1, tile.tileY * 2 + 0);
            tileRef.children[2] = this.getTileRef(tile.megaTexture.id, tile.level + 1, tile.tileX * 2 + 0, tile.tileY * 2 + 1);
            tileRef.children[3] = this.getTileRef(tile.megaTexture.id, tile.level + 1, tile.tileX * 2 + 1, tile.tileY * 2 + 1);
            for (var n = 0; n &lt; 4; n++) {
                if (tileRef.children[n]) {
                    tileRef.children[n].parent = tileRef;
                }
            }
        }

        if (tileRef.megaTexture.lookup) {
            tileRef.megaTexture.lookup.changes.push({op: &quot;add&quot;, tileRef: tileRef});
        }

        return true;
    };

    /**
     * Removes a tile from this cache.
     * @param {TileRef} tileRef Reference to the tile to remove.
     */
    Cache.prototype.removeTile = function (tileRef) {

        var key = tileRef.key;
        delete this.tiles[key];

        this.tileList.shift();
        this.freeTiles.push(tileRef.n);

        var parentRef = null;

        if (tileRef.parent) {

            tileRef.parent.children[(tileRef.tileY % 2) * 2 + (tileRef.tileX % 2)] = null;
            parentRef = tileRef.parent;
            tileRef.parent = null;

        } else if (tileRef.level &gt; 0) {

            // Try really hard to find a parent - any parent
            var tx = tileRef.tileX;
            var ty = tileRef.tileY;
            for (var level = tileRef.level - 1; level &gt;= 0; level--) {
                tx = Math.floor(tx / 2);
                ty = Math.floor(ty / 2);
                parentRef = this.getTileRef(tileRef.megaTexture.id, level, tx, ty);
                if (parentRef) {
                    break;
                }
            }
        }

        for (var n = 0; n &lt; 4; n++) {
            if (tileRef.children[n]) {
                tileRef.children[n].parent = null;
            }
        }

        tileRef.children = [null, null, null, null];

        // Queue up lookup change - but it only matters if we HAVE a lookup (on removal, we may not)
        if (tileRef.megaTexture.lookup) {

            // NOTE: it&#x27;s ok if parent is null here, as it means refresh the entire slot
            tileRef.megaTexture.lookup.changes.push({op: &quot;refresh&quot;, tileRef: parentRef});
        }

        // Draw black over the slot (needed so subregion updates/etc don&#x27;t get border artifacts)
        if (true) {

            var sx = Math.floor(tileRef.n % this.tilesPerSide) * this.totalTileSize;
            var sy = Math.floor(tileRef.n / this.tilesPerSide) * this.totalTileSize;
            var sw = this.totalTileSize;
            var sh = this.totalTileSize;

            this.quadDrawer.fill(0, 0, 0, 1, sx, sy, sw, sh);
        }
    };

    Cache.prototype.clear = function () {

        this.beginUpdate(this.renderFrameNumber);

        var tileList = this.tileList.slice(); // clone

        for (var n = 0; n &lt; tileList.length; n++) {
            var tileRef = tileList[n];
            this.removeTile(tileRef);
        }

        this.endUpdate();
    };

    Cache.prototype.getTileRef = function (megaTextureId, level, tileX, tileY) {
        var key = [megaTextureId, level, tileX, tileY].join(&quot;,&quot;);
        return this.tiles[key];
    };

    Cache.prototype.setPass1Uniforms = function (program, feedbackBuffer, megaTexture) {
        var gl = this.gl;
        gl.uniform2f(program.u_mt_params, -Math.log(feedbackBuffer.downsample) / Math.log(2), megaTexture.maxLevel);
        gl.uniform4f(program.u_mt_tex, megaTexture.width, megaTexture.height, megaTexture.tileSize, megaTexture.id);
    };

    Cache.prototype.setPass2Uniforms = function (program, megaTexture) {
        var gl = this.gl;
        gl.uniform4f(program.u_mt_tex, megaTexture.width, megaTexture.height, megaTexture.tileSize, megaTexture.id);
        gl.uniform4f(program.u_mt_texCache, this.width, this.height, 0, 0);
        gl.uniform4f(program.u_mt_texLookup, megaTexture.lookup.width, megaTexture.lookup.height, megaTexture.tileOverlap, megaTexture.maxLevel);
        gl.uniform1i(program.s_mt_lookup, 0);
        gl.uniform1i(program.s_mt_texCache, 1);
        gl.activeTexture(gl.TEXTURE0);
        gl.bindTexture(gl.TEXTURE_2D, megaTexture.lookup.texture);
        gl.activeTexture(gl.TEXTURE1);
        gl.bindTexture(gl.TEXTURE_2D, this.texture);
        gl.activeTexture(gl.TEXTURE0);
    };


    Cache.prototype.processFeedbackData = function (feedbackData, renderFrameNumber, loader) {

        var lastTexId = -1;
        var lastLevel = 0;
        var lastTileX = 0;
        var lastTileY = 0;

        var pixelIndex = 0;

        for (var yy = 0; yy &lt; feedbackData.height; yy++) {
            for (var xx = 0; xx &lt; feedbackData.width; xx++, pixelIndex += 4) {

                // TODO: remove this % - bug in WebKit/Chromium where 1 == 256 instead of 0 (sometimes?)
                var texId = feedbackData.pixels[pixelIndex + 3] % 256;

                if (texId == 0) {
                    continue;
                }

                var level = feedbackData.pixels[pixelIndex + 0] % 256;
                var tileX = feedbackData.pixels[pixelIndex + 1] % 256;
                var tileY = feedbackData.pixels[pixelIndex + 2] % 256;

                if ((texId == lastTexId) &amp;&amp; (level == lastLevel) &amp;&amp; (tileX == lastTileX) &amp;&amp; (tileY == lastTileY)) {
                    continue;
                }

                lastTexId = texId;
                lastLevel = level;
                lastTileX = tileX;
                lastTileY = tileY;

                var megaTexture = null;
                var tileRef = this.getTileRef(texId, level, tileX, tileY);

                if (tileRef) {
                    megaTexture = tileRef.megaTexture;
                    tileRef.touch(renderFrameNumber);

                } else {

                    megaTexture = this.megaTextures[texId];

                    if (!megaTexture) {
                        // texture not found - that&#x27;s bad!
                        continue;
                    }

                    var tile = loader.queue(megaTexture, level, tileX, tileY);
                    tile.lastUse = renderFrameNumber;
                }

                if (level &gt; 0) {

                    // For each coarser level, touch or request the parent tile
                    // Priority is handled by the loader based on level

                    var tx = tileX;
                    var ty = tileY;
                    var lastRef = tileRef;

                    for (var l = level - 1; l &gt;= 0; l--) {

                        tx = Math.floor(tx / 2);
                        ty = Math.floor(ty / 2);

                        var parentRef = lastRef ? lastRef.parent : this.getTileRef(texId, l, tx, ty);

                        if (parentRef) {

                            parentRef.touch(renderFrameNumber);

                            if (lastRef) {
                                lastRef.parent = parentRef;
                            }

                            lastRef = parentRef;

                        } else {

                            var tile = loader.queue(megaTexture, l, tx, ty);
                            tile.lastUse = renderFrameNumber;
                            lastRef = null;
                        }
                    }
                }
            }
        }
    };

    Cache.prototype.destroy = function () {

        var gl = this.gl;

        this.quadDrawer.destroy();
        this.quadDrawer = null;

        gl.deleteTexture(this.texture);

        this.texture = null;

        gl.deleteFramebuffer(this.framebuffer);

        this.framebuffer = null;

        this.gl = null;
    };

})();
    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
